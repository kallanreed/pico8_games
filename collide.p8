pico-8 cartridge // http://www.pico-8.com
version 33
__lua__

function overlaps(a,b)
 local ax2=a.x+a.w-1
 local ay2=a.y+a.h-1
 local bx2=b.x+b.w-1
 local by2=b.y+b.h-1
 -- no overlap if any true
 return not (ax2<b.x
          or a.x>bx2
          or ay2<b.y
          or a.y>by2)
end

function spget(sp,x,y)
 local sx=sp%16*8
 local sy=flr(sp/16)*8
 return sget(sx+x,sy+y)
end

-- true if any pixels overlap
-- needs {sp,x,y,w,h}
-- doesn't account for flip
function pxl_overlap(a,b)
 local offx=b.x-a.x
 local offy=b.y-a.y
 
 local rx1=a.x
 local rx2=min(a.w+a.x,
               b.w+b.x)-1
 local ry1=a.y
 local ry2=min(a.h-a.y,
               b.h-b.y)-1
 
  if offx>0 then
  -- left b is left r
  rx1=b.x
  rx2=b.x+min(b.w,a.w-offx)-1
 elseif offx<0 then
  -- left a is left r
  rx1=a.x
  rx2=a.x+min(a.w,b.w+offx)-1
 end
 
 if offy>0 then
  -- top of b is top r
  ry1=b.y
  ry2=b.y+min(b.h,a.h-offy)-1
 elseif offy<0 then
  -- top of a is top r
  ry1=a.y
  ry2=a.y+min(a.h,b.h+offy)-1
 end

 local aoffx=rx1-a.x
 local aoffy=ry1-a.y
 local boffx=rx1-b.x
 local boffy=ry1-b.y
 
 for x=0,(rx2-rx1) do
  for y=0,(ry2-ry1) do
   local pa=spget(a.sp,aoffx+x,aoffy+y)
   local pb=spget(b.sp,boffx+x,boffy+y)
   if pa>0 and pb>0 then
    return true
   end
  end
 end
 
 return false
end

function ovr_rect(a,b)
 local ax2=a.x+a.w-1
 local ay2=a.y+a.h-1
 local bx2=b.x+b.w-1
 local by2=b.y+b.h-1

 local offx=b.x-a.x
 local offy=b.y-a.y
 
 local rx1=a.x
 local rx2=min(ax2,bx2)
 local ry1=a.y
 local ry2=min(ay2,bx2)
 
 print(offx..","..offy)

 if offx>0 then
  -- left b is left r
  rx1=b.x
  rx2=b.x+min(b.w,a.w-offx)-1
 elseif offx<0 then
  -- left a is left r
  rx1=a.x
  rx2=a.x+min(a.w,b.w+offx)-1
 end
 
 if offy>0 then
  -- top of b is top r
  ry1=b.y
  ry2=b.y+min(b.h,a.h-offy)-1
 elseif offy<0 then
  -- top of a is top r
  ry1=a.y
  ry2=a.y+min(a.h,b.h+offy)-1
 end
 
 if not show_px then
  rect(rx1,ry1,rx2,ry2,7)
  pset(rx1,ry1,11)
 end

 local aoffx=rx1-a.x
 local aoffy=ry1-a.y
 local boffx=rx1-b.x
 local boffy=ry1-b.y
 print("a:"..aoffx..","..aoffy)

 for x=0,(rx2-rx1) do
  for y=0,(ry2-ry1) do
   local pa=spget(a.sp,aoffx+x,aoffy+y)
   local pb=spget(b.sp,boffx+x,boffy+y)
   pset(50+x,50+y,pa)
   pset(60+x,50+y,pb)
   if pa>0 and pb>0 then
    pset(70+x,50+y,7)
    if show_px then
     pset(a.x+aoffx+x,
          a.y+aoffy+y,11)
    end
   end
  end
 end
end

function _init()
 p={
  sp=4,
  x=30,y=30,
  w=8,h=8
 }
 b={
  sp=5,
  x=40,y=30,
  w=8,h=8
 }
 
 show_px=false
end

function _update()
 if btn(⬆️) then p.y-=1
 elseif btn(⬇️) then p.y+=1
 elseif btn(⬅️) then p.x-=1
 elseif btn(➡️) then p.x+=1
 end
 if btnp(❎) then
  show_px=not show_px
 end
end

function _draw()
 cls()
 spr(p.sp,p.x,p.y,p.w/8,p.h/8)
 spr(b.sp,b.x,b.y,b.w/8,b.h/8)

 local o=overlaps(p,b)
 color(6)
 print("overlap="..tostring(o))

 if o then
  if(pxl_overlap(p,b)) ?"pixel overlap"
  ovr_rect(p,b)
 end
end


__gfx__
00000000888888880099990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888800099990000eeee00000400000060006000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070088888800000990000e0000e0000800000004240000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700088888000099999900e0303e0044444000662226600000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700088880000000990000e0000e044fff4400002220000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070088800000009009000e0000e0457557400064246000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000880000000090090000eeee00f55f55f00608280600000000000000000000000000000000000000000000000000000000000000000000000000000000
000000008000000000900900000ee000ff444ff00006060000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000008000000000eeeeee0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000088000000000e0ee0e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000088800000000000ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000088000000000000eeee00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000888000000000000e00e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008888880000000000e00e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888880000000000e00e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000888888880000000000e00e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
